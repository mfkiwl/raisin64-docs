

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>raisin64.v &mdash; Raisin64 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="ram.v" href="ram.html" />
    <link rel="prev" title="pipeline.v" href="pipeline.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Raisin64
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../cpu.html">Raisin64 CPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software.html">Code Snippets and Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nexysddr.html">Nexys 4 DDR Reference Implementation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../modules.html">Reference Index</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../isa.html">Raisin64 Instruction Set</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../modules.html">Verilog Module Index</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="commit.html">commit.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="de_canonicalize.html">de_canonicalize.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="debug_control.html">debug_control.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="decode.html">decode.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="ex_advint.html">ex_advint.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="ex_advint_s1.html">ex_advint_s1.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="ex_alu.html">ex_alu.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="ex_alu_s1.html">ex_alu_s1.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="ex_branch.html">ex_branch.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="ex_memory.html">ex_memory.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="fetch.html">fetch.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="ff_sync.html">ff_sync.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="jtag_reg.html">schedule.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="jtag_state_machine.html">jtag_state_machine.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="jtaglet.html">jtaglet.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="memory_map.html">memory_map.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="pipeline.html">pipeline.v</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">raisin64.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="ram.html">ram.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="regfile.html">regfile.v</a></li>
<li class="toctree-l3"><a class="reference internal" href="schedule.html">schedule.v</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Raisin64</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../modules.html">Reference Index</a> &raquo;</li>
        
          <li><a href="../modules.html">Verilog Module Index</a> &raquo;</li>
        
      <li>raisin64.v</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/cpu/modules/raisin64.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="raisin64-v">
<h1>raisin64.v<a class="headerlink" href="#raisin64-v" title="Permalink to this headline">Â¶</a></h1>
<object data="../../_images/symbol-abc5946fc42805f451facd38aa22b477693c24b7.svg" type="image/svg+xml">
            <p class="warning">/*
 * Raisin64 CPU
 */

module raisin64 (
    //# {{clocks|Clocking}}
    input clk,
    input rst_n,

    //# {{data|Memory Interface}}
    input[63:0] mem_din,
    output[63:0] mem_dout,
    output[63:0] mem_addr,

    //# {{control|Control Signals}}
    output mem_addr_valid,
    output mem_dout_write,
    input mem_din_ready,

    //# {{debug|Debug Signals}}
    input jtag_tck,
    input jtag_tms,
    input jtag_tdi,
    input jtag_trst,
    output jtag_tdo
    );

    parameter IMEM_INIT = &quot;&quot;;
    parameter DMEM_INIT = &quot;&quot;;

    //// Debug Signals ////
    wire dbg_resetn_cpu, dbg_halt_cpu;
    wire cpu_rst_n;
    assign cpu_rst_n = rst_n &amp; dbg_resetn_cpu;

    wire[63:0] dbg_imem_addr;
    wire[63:0] dbg_imem_to_ram;
    wire dbg_imem_ce;
    wire dbg_imem_we;

    wire[63:0] dbg_dmem_addr;
    wire[63:0] dbg_dmem_to_ram;
    wire dbg_dmem_ce;
    wire dbg_dmem_we;


    //////////  Instruction RAM  //////////
    wire[63:0] effective_imem_addr;
    wire[63:0] effective_imem_data_to_cpu;

    reg imem_data_ready;
    wire imem_addr_valid;
    wire[63:0] imem_addr;
    wire[63:0] imem_data;

    assign effective_imem_addr        = dbg_halt_cpu ? dbg_imem_addr : imem_addr;
    assign effective_imem_data_to_cpu = dbg_halt_cpu ? 64'h0 : imem_data;

    always &#64;(posedge clk or negedge rst_n) begin
        if(~rst_n) imem_data_ready &lt;= 0;
        else imem_data_ready &lt;= imem_addr_valid;
    end

    ram #(
        .NUM_BYTES(2*1024),
        .INIT_FILE(IMEM_INIT)
        ) imem (
        .clk(clk),
        .we(dbg_imem_we), .cs(1'b1),
        .write_width(2'h0),
        .addr(effective_imem_addr),
        .data_in(dbg_imem_to_ram),
        .data_out(imem_data)
        );


    //////////  Data RAM  //////////
    wire[63:0] effective_dmem_addr;
    wire[63:0] effective_dmem_to_ram;

    wire[63:0] dmem_addr;
    wire[63:0] dmem_to_ram;
    wire[63:0] dmem_to_cpu;
    wire[63:0] dmem_from_ram;
    wire[1:0] dmem_write_width;
    reg dmem_cycle_complete;
    wire dmem_rstrobe;
    wire dmem_wstrobe;

    wire io_space;

    assign effective_dmem_addr        = dbg_halt_cpu ? dbg_dmem_addr : dmem_addr;
    assign effective_dmem_to_ram      = dbg_halt_cpu ? dbg_dmem_to_ram : dmem_to_ram;

    //TODO For now, the external memory bus is just for data memory.  When the time
    //comes for caches, this will change to the unified external memory bus.
    assign dmem_to_cpu                = io_space ? mem_din : dmem_from_ram;
    assign mem_dout                   = effective_dmem_to_ram;
    assign mem_addr                   = effective_dmem_addr;
    assign mem_addr_valid             = 1;
    assign mem_dout_write             = dbg_halt_cpu ? dbg_dmem_we : dmem_wstrobe;

    //Because the memory interface will change dramatically in the next revision, there
    //is no reason to create special logic to handle misaligned accesses into data space
    //in case an IO unit requires it (the ram modules handle this condition internally).
    //Instead we simply state misaligned IO access it is unsupported (for now).
    always &#64;(*) begin
        if((dmem_rstrobe|dmem_wstrobe) &amp; io_space &amp; |dmem_write_width &amp; ~clk) begin
            $display(&quot;Unaligned data IO access not supported in this revision&quot;);
            $finish;
        end
    end

    memory_map memory_map_internal(
        .addr(mem_addr),
        .io(io_space)
        );

    always &#64;(posedge clk or negedge cpu_rst_n)
    begin
        if(~cpu_rst_n) dmem_cycle_complete &lt;= 0;
        else if(io_space &amp; mem_din_ready) dmem_cycle_complete &lt;= 1;
        else if(dmem_rstrobe) dmem_cycle_complete &lt;= 1;
        else if(dmem_wstrobe) dmem_cycle_complete &lt;= 1;
        else dmem_cycle_complete &lt;= 0;
    end

    ram #(
        .NUM_BYTES(512),
        .INIT_FILE(DMEM_INIT)
        ) dmem (
        .clk(clk),
        .we(~io_space &amp; (dmem_wstrobe|dbg_dmem_we)), .cs(~io_space &amp; (dmem_wstrobe|dmem_rstrobe|dbg_dmem_ce)),
        .write_width(dmem_write_width),
        .addr(effective_dmem_addr),
        .data_in(effective_dmem_to_ram),
        .data_out(dmem_from_ram)
        );


    //////////  Raisin64 Execution Core  //////////
    pipeline pipeline1(
        .clk(clk),
        .rst_n(cpu_rst_n),
        .imem_addr(imem_addr),
        .imem_data(effective_imem_data_to_cpu),
        .imem_data_valid(imem_data_ready),
        .imem_addr_valid(imem_addr_valid),
        .dmem_addr(dmem_addr), .dmem_dout(dmem_to_ram),
        .dmem_din(dmem_to_cpu),
        .dmem_cycle_complete(dmem_cycle_complete &amp; ~dmem_rstrobe &amp; ~dmem_wstrobe),
        .dmem_write_width(dmem_write_width),
        .dmem_rstrobe(dmem_rstrobe),
        .dmem_wstrobe(dmem_wstrobe)
        );


    //////////  JTAG Module  //////////
    debug_control debug_if(
        .jtag_tck(jtag_tck),
        .jtag_tms(jtag_tms),
        .jtag_tdo(jtag_tdo),
        .jtag_tdi(jtag_tdi),
        .jtag_trst(jtag_trst),
        .cpu_clk(clk),
        .sys_rstn(rst_n),
        .cpu_imem_addr(dbg_imem_addr),
        .cpu_debug_to_imem_data(dbg_imem_to_ram),
        .cpu_imem_to_debug_data(imem_data),
        .cpu_imem_we(dbg_imem_we),
        .cpu_imem_ce(dbg_imem_ce),
        .cpu_dmem_addr(dbg_dmem_addr),
        .cpu_debug_to_dmem_data(dbg_dmem_to_ram),
        .cpu_imem_to_debug_data_ready(dbg_imem_ce &amp; ~dbg_imem_we),
        .cpu_dmem_to_debug_data_ready(dbg_dmem_ce &amp; ~dbg_dmem_we),
        .cpu_dmem_to_debug_data(dmem_to_cpu),
        .cpu_dmem_we(dbg_dmem_we),
        .cpu_dmem_ce(dbg_dmem_ce),
        .cpu_resetn_cpu(dbg_resetn_cpu),
        .cpu_halt_cpu(dbg_halt_cpu)
        );

endmodule</p></object>
<div class="highlight-verilog notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Raisin64 CPU</span>
<span class="cm"> */</span>

<span class="k">module</span> <span class="n">raisin64</span> <span class="p">(</span>
    <span class="c1">//# {{clocks|Clocking}}</span>
    <span class="k">input</span> <span class="n">clk</span><span class="p">,</span>
    <span class="k">input</span> <span class="n">rst_n</span><span class="p">,</span>

    <span class="c1">//# {{data|Memory Interface}}</span>
    <span class="k">input</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">mem_din</span><span class="p">,</span>
    <span class="k">output</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">mem_dout</span><span class="p">,</span>
    <span class="k">output</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">mem_addr</span><span class="p">,</span>

    <span class="c1">//# {{control|Control Signals}}</span>
    <span class="k">output</span> <span class="n">mem_addr_valid</span><span class="p">,</span>
    <span class="k">output</span> <span class="n">mem_dout_write</span><span class="p">,</span>
    <span class="k">input</span> <span class="n">mem_din_ready</span><span class="p">,</span>

    <span class="c1">//# {{debug|Debug Signals}}</span>
    <span class="k">input</span> <span class="n">jtag_tck</span><span class="p">,</span>
    <span class="k">input</span> <span class="n">jtag_tms</span><span class="p">,</span>
    <span class="k">input</span> <span class="n">jtag_tdi</span><span class="p">,</span>
    <span class="k">input</span> <span class="n">jtag_trst</span><span class="p">,</span>
    <span class="k">output</span> <span class="n">jtag_tdo</span>
    <span class="p">);</span>

    <span class="k">parameter</span> <span class="no">IMEM_INIT</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="no">DMEM_INIT</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="c1">//// Debug Signals ////</span>
    <span class="kt">wire</span> <span class="n">dbg_resetn_cpu</span><span class="p">,</span> <span class="n">dbg_halt_cpu</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="n">cpu_rst_n</span><span class="p">;</span>
    <span class="k">assign</span> <span class="n">cpu_rst_n</span> <span class="o">=</span> <span class="n">rst_n</span> <span class="o">&amp;</span> <span class="n">dbg_resetn_cpu</span><span class="p">;</span>

    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dbg_imem_addr</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dbg_imem_to_ram</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="n">dbg_imem_ce</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="n">dbg_imem_we</span><span class="p">;</span>

    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dbg_dmem_addr</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dbg_dmem_to_ram</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="n">dbg_dmem_ce</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="n">dbg_dmem_we</span><span class="p">;</span>


    <span class="c1">//////////  Instruction RAM  //////////</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">effective_imem_addr</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">effective_imem_data_to_cpu</span><span class="p">;</span>

    <span class="kt">reg</span> <span class="n">imem_data_ready</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="n">imem_addr_valid</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">imem_addr</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">imem_data</span><span class="p">;</span>

    <span class="k">assign</span> <span class="n">effective_imem_addr</span>        <span class="o">=</span> <span class="n">dbg_halt_cpu</span> <span class="o">?</span> <span class="n">dbg_imem_addr</span> <span class="o">:</span> <span class="n">imem_addr</span><span class="p">;</span>
    <span class="k">assign</span> <span class="n">effective_imem_data_to_cpu</span> <span class="o">=</span> <span class="n">dbg_halt_cpu</span> <span class="o">?</span> <span class="mh">64&#39;h0</span> <span class="o">:</span> <span class="n">imem_data</span><span class="p">;</span>

    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span> <span class="k">or</span> <span class="k">negedge</span> <span class="n">rst_n</span><span class="p">)</span> <span class="k">begin</span>
        <span class="k">if</span><span class="p">(</span><span class="o">~</span><span class="n">rst_n</span><span class="p">)</span> <span class="n">imem_data_ready</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">imem_data_ready</span> <span class="o">&lt;=</span> <span class="n">imem_addr_valid</span><span class="p">;</span>
    <span class="k">end</span>

    <span class="n">ram</span> <span class="p">#(</span>
        <span class="p">.</span><span class="no">NUM_BYTES</span><span class="p">(</span><span class="mh">2</span><span class="o">*</span><span class="mh">1024</span><span class="p">),</span>
        <span class="p">.</span><span class="no">INIT_FILE</span><span class="p">(</span><span class="no">IMEM_INIT</span><span class="p">)</span>
        <span class="p">)</span> <span class="n">imem</span> <span class="p">(</span>
        <span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
        <span class="p">.</span><span class="n">we</span><span class="p">(</span><span class="n">dbg_imem_we</span><span class="p">),</span> <span class="p">.</span><span class="n">cs</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span>
        <span class="p">.</span><span class="n">write_width</span><span class="p">(</span><span class="mh">2&#39;h0</span><span class="p">),</span>
        <span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">effective_imem_addr</span><span class="p">),</span>
        <span class="p">.</span><span class="n">data_in</span><span class="p">(</span><span class="n">dbg_imem_to_ram</span><span class="p">),</span>
        <span class="p">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">imem_data</span><span class="p">)</span>
        <span class="p">);</span>


    <span class="c1">//////////  Data RAM  //////////</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">effective_dmem_addr</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">effective_dmem_to_ram</span><span class="p">;</span>

    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dmem_addr</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dmem_to_ram</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dmem_to_cpu</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dmem_from_ram</span><span class="p">;</span>
    <span class="kt">wire</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dmem_write_width</span><span class="p">;</span>
    <span class="kt">reg</span> <span class="n">dmem_cycle_complete</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="n">dmem_rstrobe</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="n">dmem_wstrobe</span><span class="p">;</span>

    <span class="kt">wire</span> <span class="n">io_space</span><span class="p">;</span>

    <span class="k">assign</span> <span class="n">effective_dmem_addr</span>        <span class="o">=</span> <span class="n">dbg_halt_cpu</span> <span class="o">?</span> <span class="n">dbg_dmem_addr</span> <span class="o">:</span> <span class="n">dmem_addr</span><span class="p">;</span>
    <span class="k">assign</span> <span class="n">effective_dmem_to_ram</span>      <span class="o">=</span> <span class="n">dbg_halt_cpu</span> <span class="o">?</span> <span class="n">dbg_dmem_to_ram</span> <span class="o">:</span> <span class="n">dmem_to_ram</span><span class="p">;</span>

    <span class="c1">//TODO For now, the external memory bus is just for data memory.  When the time</span>
    <span class="c1">//comes for caches, this will change to the unified external memory bus.</span>
    <span class="k">assign</span> <span class="n">dmem_to_cpu</span>                <span class="o">=</span> <span class="n">io_space</span> <span class="o">?</span> <span class="n">mem_din</span> <span class="o">:</span> <span class="n">dmem_from_ram</span><span class="p">;</span>
    <span class="k">assign</span> <span class="n">mem_dout</span>                   <span class="o">=</span> <span class="n">effective_dmem_to_ram</span><span class="p">;</span>
    <span class="k">assign</span> <span class="n">mem_addr</span>                   <span class="o">=</span> <span class="n">effective_dmem_addr</span><span class="p">;</span>
    <span class="k">assign</span> <span class="n">mem_addr_valid</span>             <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
    <span class="k">assign</span> <span class="n">mem_dout_write</span>             <span class="o">=</span> <span class="n">dbg_halt_cpu</span> <span class="o">?</span> <span class="n">dbg_dmem_we</span> <span class="o">:</span> <span class="n">dmem_wstrobe</span><span class="p">;</span>

    <span class="c1">//Because the memory interface will change dramatically in the next revision, there</span>
    <span class="c1">//is no reason to create special logic to handle misaligned accesses into data space</span>
    <span class="c1">//in case an IO unit requires it (the ram modules handle this condition internally).</span>
    <span class="c1">//Instead we simply state misaligned IO access it is unsupported (for now).</span>
    <span class="k">always</span> <span class="p">@(</span><span class="o">*</span><span class="p">)</span> <span class="k">begin</span>
        <span class="k">if</span><span class="p">((</span><span class="n">dmem_rstrobe</span><span class="o">|</span><span class="n">dmem_wstrobe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">io_space</span> <span class="o">&amp;</span> <span class="o">|</span><span class="n">dmem_write_width</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
            <span class="nb">$display</span><span class="p">(</span><span class="s">&quot;Unaligned data IO access not supported in this revision&quot;</span><span class="p">);</span>
            <span class="nb">$finish</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">memory_map</span> <span class="n">memory_map_internal</span><span class="p">(</span>
        <span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">mem_addr</span><span class="p">),</span>
        <span class="p">.</span><span class="n">io</span><span class="p">(</span><span class="n">io_space</span><span class="p">)</span>
        <span class="p">);</span>

    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span> <span class="k">or</span> <span class="k">negedge</span> <span class="n">cpu_rst_n</span><span class="p">)</span>
    <span class="k">begin</span>
        <span class="k">if</span><span class="p">(</span><span class="o">~</span><span class="n">cpu_rst_n</span><span class="p">)</span> <span class="n">dmem_cycle_complete</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">io_space</span> <span class="o">&amp;</span> <span class="n">mem_din_ready</span><span class="p">)</span> <span class="n">dmem_cycle_complete</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dmem_rstrobe</span><span class="p">)</span> <span class="n">dmem_cycle_complete</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dmem_wstrobe</span><span class="p">)</span> <span class="n">dmem_cycle_complete</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">dmem_cycle_complete</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
    <span class="k">end</span>

    <span class="n">ram</span> <span class="p">#(</span>
        <span class="p">.</span><span class="no">NUM_BYTES</span><span class="p">(</span><span class="mh">512</span><span class="p">),</span>
        <span class="p">.</span><span class="no">INIT_FILE</span><span class="p">(</span><span class="no">DMEM_INIT</span><span class="p">)</span>
        <span class="p">)</span> <span class="n">dmem</span> <span class="p">(</span>
        <span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
        <span class="p">.</span><span class="n">we</span><span class="p">(</span><span class="o">~</span><span class="n">io_space</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dmem_wstrobe</span><span class="o">|</span><span class="n">dbg_dmem_we</span><span class="p">)),</span> <span class="p">.</span><span class="n">cs</span><span class="p">(</span><span class="o">~</span><span class="n">io_space</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dmem_wstrobe</span><span class="o">|</span><span class="n">dmem_rstrobe</span><span class="o">|</span><span class="n">dbg_dmem_ce</span><span class="p">)),</span>
        <span class="p">.</span><span class="n">write_width</span><span class="p">(</span><span class="n">dmem_write_width</span><span class="p">),</span>
        <span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">effective_dmem_addr</span><span class="p">),</span>
        <span class="p">.</span><span class="n">data_in</span><span class="p">(</span><span class="n">effective_dmem_to_ram</span><span class="p">),</span>
        <span class="p">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">dmem_from_ram</span><span class="p">)</span>
        <span class="p">);</span>


    <span class="c1">//////////  Raisin64 Execution Core  //////////</span>
    <span class="n">pipeline</span> <span class="n">pipeline1</span><span class="p">(</span>
        <span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
        <span class="p">.</span><span class="n">rst_n</span><span class="p">(</span><span class="n">cpu_rst_n</span><span class="p">),</span>
        <span class="p">.</span><span class="n">imem_addr</span><span class="p">(</span><span class="n">imem_addr</span><span class="p">),</span>
        <span class="p">.</span><span class="n">imem_data</span><span class="p">(</span><span class="n">effective_imem_data_to_cpu</span><span class="p">),</span>
        <span class="p">.</span><span class="n">imem_data_valid</span><span class="p">(</span><span class="n">imem_data_ready</span><span class="p">),</span>
        <span class="p">.</span><span class="n">imem_addr_valid</span><span class="p">(</span><span class="n">imem_addr_valid</span><span class="p">),</span>
        <span class="p">.</span><span class="n">dmem_addr</span><span class="p">(</span><span class="n">dmem_addr</span><span class="p">),</span> <span class="p">.</span><span class="n">dmem_dout</span><span class="p">(</span><span class="n">dmem_to_ram</span><span class="p">),</span>
        <span class="p">.</span><span class="n">dmem_din</span><span class="p">(</span><span class="n">dmem_to_cpu</span><span class="p">),</span>
        <span class="p">.</span><span class="n">dmem_cycle_complete</span><span class="p">(</span><span class="n">dmem_cycle_complete</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dmem_rstrobe</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dmem_wstrobe</span><span class="p">),</span>
        <span class="p">.</span><span class="n">dmem_write_width</span><span class="p">(</span><span class="n">dmem_write_width</span><span class="p">),</span>
        <span class="p">.</span><span class="n">dmem_rstrobe</span><span class="p">(</span><span class="n">dmem_rstrobe</span><span class="p">),</span>
        <span class="p">.</span><span class="n">dmem_wstrobe</span><span class="p">(</span><span class="n">dmem_wstrobe</span><span class="p">)</span>
        <span class="p">);</span>


    <span class="c1">//////////  JTAG Module  //////////</span>
    <span class="n">debug_control</span> <span class="n">debug_if</span><span class="p">(</span>
        <span class="p">.</span><span class="n">jtag_tck</span><span class="p">(</span><span class="n">jtag_tck</span><span class="p">),</span>
        <span class="p">.</span><span class="n">jtag_tms</span><span class="p">(</span><span class="n">jtag_tms</span><span class="p">),</span>
        <span class="p">.</span><span class="n">jtag_tdo</span><span class="p">(</span><span class="n">jtag_tdo</span><span class="p">),</span>
        <span class="p">.</span><span class="n">jtag_tdi</span><span class="p">(</span><span class="n">jtag_tdi</span><span class="p">),</span>
        <span class="p">.</span><span class="n">jtag_trst</span><span class="p">(</span><span class="n">jtag_trst</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
        <span class="p">.</span><span class="n">sys_rstn</span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_imem_addr</span><span class="p">(</span><span class="n">dbg_imem_addr</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_debug_to_imem_data</span><span class="p">(</span><span class="n">dbg_imem_to_ram</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_imem_to_debug_data</span><span class="p">(</span><span class="n">imem_data</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_imem_we</span><span class="p">(</span><span class="n">dbg_imem_we</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_imem_ce</span><span class="p">(</span><span class="n">dbg_imem_ce</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_dmem_addr</span><span class="p">(</span><span class="n">dbg_dmem_addr</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_debug_to_dmem_data</span><span class="p">(</span><span class="n">dbg_dmem_to_ram</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_imem_to_debug_data_ready</span><span class="p">(</span><span class="n">dbg_imem_ce</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dbg_imem_we</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_dmem_to_debug_data_ready</span><span class="p">(</span><span class="n">dbg_dmem_ce</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">dbg_dmem_we</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_dmem_to_debug_data</span><span class="p">(</span><span class="n">dmem_to_cpu</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_dmem_we</span><span class="p">(</span><span class="n">dbg_dmem_we</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_dmem_ce</span><span class="p">(</span><span class="n">dbg_dmem_ce</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_resetn_cpu</span><span class="p">(</span><span class="n">dbg_resetn_cpu</span><span class="p">),</span>
        <span class="p">.</span><span class="n">cpu_halt_cpu</span><span class="p">(</span><span class="n">dbg_halt_cpu</span><span class="p">)</span>
        <span class="p">);</span>

<span class="k">endmodule</span>
</pre></div>
</td></tr></table></div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ram.html" class="btn btn-neutral float-right" title="ram.v" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pipeline.html" class="btn btn-neutral" title="pipeline.v" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Christopher Parish

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>